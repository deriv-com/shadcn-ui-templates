name: Publish CLI to NPM

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release to trigger'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      current_version:
        description: 'Current version (e.g., 1.0.0) - leave empty to auto-detect'
        required: false
        default: ''
      create_tag:
        description: 'Create and push a git tag for this version'
        required: false
        default: true
        type: boolean

# Set permissions for npm publishing
permissions:
  contents: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "npm-publish"
  cancel-in-progress: false

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # v4.0.1
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build CLI
      run: |
        cd cli
        npm install
        npm run build
      working-directory: .
      
    - name: Verify CLI build output
      run: |
        echo "üì¶ CLI build output verification:"
        ls -la cli/dist/
        echo ""
        echo "üìÅ CLI Components:"
        ls -la cli/dist/components/ || echo "No components directory"
        echo ""
        echo "üìÅ CLI Config:"
        ls -la cli/dist/config/ || echo "No config directory"
        echo ""
        echo "üìÅ CLI Styles:"
        ls -la cli/dist/styles/ || echo "No styles directory"
        echo ""
        echo "üìÅ CLI Override:"
        ls -la cli/dist/override/ || echo "No override directory"
        echo ""
        echo "üìÑ CLI Package files:"
        ls -la cli/package.json cli/dist/index.js || echo "Missing CLI package files"
        
    - name: Get current version
      id: get_version
      run: |
        if [ -n "${{ github.event.inputs.current_version }}" ]; then
          CURRENT_VERSION="${{ github.event.inputs.current_version }}"
        else
          # Try to get version from CLI package.json
          if [ -f "cli/package.json" ]; then
            CURRENT_VERSION=$(node -p "require('./cli/package.json').version")
          else
            CURRENT_VERSION="0.0.0"
          fi
        fi
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "üì¶ Current CLI version: $CURRENT_VERSION"
        
    - name: Calculate new version
      id: calc_version
      run: |
        CURRENT_VERSION="${{ steps.get_version.outputs.current_version }}"
        RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        
        # Parse current version
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # Calculate new version based on release type
        case "$RELEASE_TYPE" in
          "patch")
            NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
            ;;
          "minor")
            NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
            ;;
          "major")
            NEW_VERSION="$((MAJOR + 1)).0.0"
            ;;
          *)
            echo "‚ùå Invalid release type: $RELEASE_TYPE"
            exit 1
            ;;
        esac
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "üì¶ New version: $NEW_VERSION ($RELEASE_TYPE release)"
        echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
        
    - name: Update CLI package.json version
      run: |
        cd cli
        npm version $VERSION --no-git-tag-version
        echo "üì¶ Updated CLI package.json to version: $VERSION"
        
    - name: Create git tag
      if: github.event.inputs.create_tag == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v$VERSION" -m "Release v$VERSION"
        echo "üè∑Ô∏è Created tag: v$VERSION"
        
    - name: Publish CLI to NPM
      run: |
        cd cli
        echo "üöÄ Publishing @deriv-com/quill-shadcn-cli@$VERSION to NPM..."
        npm publish --access public
        echo "‚úÖ Successfully published CLI to NPM!"
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        
    - name: Push tag and create GitHub Release
      if: github.event.inputs.create_tag == 'true'
      run: |
        git push origin "v$VERSION"
        echo "üè∑Ô∏è Pushed tag: v$VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create GitHub Release
      if: github.event.inputs.create_tag == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.calc_version.outputs.new_version }}
        release_name: Release v${{ steps.calc_version.outputs.new_version }} (${{ github.event.inputs.release_type }})
        body: |
          üöÄ **@deriv-com/quill-shadcn-cli v${{ steps.calc_version.outputs.new_version }}**
          
          **Release Type:** ${{ github.event.inputs.release_type }}
          **Previous Version:** ${{ steps.get_version.outputs.current_version }}
          
          ## What's New
          - CLI tool for easy Deriv Quill component installation
          - Complete setup with all 43 components
          - Tailwind, PostCSS, and global CSS configuration
          - Design token integration
          - Simple install and update commands
          
          ## Installation
          ```bash
          npm install -g @deriv-com/quill-shadcn-cli@${{ steps.calc_version.outputs.new_version }}
          ```
          
          ## Usage
          ```bash
          # Complete setup (installs all components + config)
          quill-shadcn install
          
          # Update to latest version
          quill-shadcn update
          ```
          
          ## Features
          - ‚úÖ All 43 shadcn/ui components with Deriv design tokens
          - ‚úÖ Complete Tailwind configuration
          - ‚úÖ Global CSS with design variables
          - ‚úÖ PostCSS and components.json setup
          - ‚úÖ Framework detection (React, Next.js, Vite)
          
          ## Changelog
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.
        draft: false
        prerelease: false
